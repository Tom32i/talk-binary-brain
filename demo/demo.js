(()=>{"use strict";const t=new Map([[2,Uint8Array],[4,Int16Array],[8,Int32Array],[16,Float32Array],[64,Float64Array],[256,Int8Array],[512,Uint16Array],[768,Uint32Array]]);function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}const o=function(){function o(t){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];e(this,o),this.littleEndian=!0,this.buffer=t,this.header=new DataView(t,0,o.HEADER_LENGTH),this.cache=new Map,this.body=n?this.createBodyView():null}var i,s,a;return i=o,s=[{key:"x",get:function(){return this.header.getUint16(42,this.littleEndian)}},{key:"y",get:function(){return this.header.getUint16(44,this.littleEndian)}},{key:"z",get:function(){return this.header.getUint16(46,this.littleEndian)}},{key:"bitPerVoxel",get:function(){return this.header.getUint16(72,this.littleEndian)}},{key:"dataType",get:function(){return this.header.getUint16(70,this.littleEndian)}},{key:"createBodyView",value:function(){return new(t.get(this.dataType))(this.buffer,o.HEADER_LENGTH)}},{key:"getSlice",value:function(t,e){var n="".concat(t,"-").concat(e);return this.cache.has(n)||this.cache.set(n,this.renderSlice(t,e)),this.cache.get(n)}},{key:"renderSlice",value:function(t,e){var n=this.getDimensions(t),i=n.width,s=n.height,a=n.length,r=n.offsetWidth,l=n.offsetHeight,c=n.offset;if(e<0||e>=a)throw new Error("Position '".concat(e,"' is invalid [0, ").concat(a,"[."));for(var h=new ImageData(i,s),u=e*c,f=0,d=0;d<s;d++)for(var g=u+(s-d)*l,y=0;y<i;y++,f+=4){var v=g+(i-y)*r,m=this.body[v],p=Math.round(m/o.MAX*255);h.data.fill(p,f,f+3),h.data.set([255],f+3)}return h}},{key:"getXYZOffset",value:function(t,e,n){var o=1*t+e*(1*this.x)+n*(1*this.x*this.y);console.log("[%s,%s,%s] (%s) = %s",t,e,n,o,this.body[o])}},{key:"getDimensions",value:function(t){var e=o.AXIS.slice(0);return e.splice(e.indexOf(t),1),{length:this[t],width:this[e[0]],height:this[e[1]],offset:this.getOffset(t),offsetWidth:this.getOffset(e[0]),offsetHeight:this.getOffset(e[1])}}},{key:"getOffset",value:function(t){for(var e=o.AXIS,n=e.length,i=1,s=0;s<n;s++){var a=e[s];if(a===t)break;i*=this[a]}return i}},{key:"setDefaultHeader",value:function(t,e,n,i,s){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:255,l=this.header,c=this.littleEndian,h=this.buffer;l.setUint32(0,348,c),l.setUint16(40,3,c),l.setUint16(42,t,c),l.setUint16(44,e,c),l.setUint16(46,n,c),l.setUint16(48,1,c),l.setUint16(50,1,c),l.setUint16(52,1,c),l.setUint16(54,1,c),l.setUint16(70,s,c),l.setUint16(72,i,c),l.setFloat32(76,1,c),l.setFloat32(80,1,c),l.setFloat32(84,1,c),l.setFloat32(88,1,c),l.setFloat32(92,0,c),l.setFloat32(108,o.HEADER_LENGTH,c),l.setFloat32(112,1,c),l.setFloat32(116,0,c),l.setUint16(122,512,c),l.setUint16(123,2,c),l.setFloat32(124,r,c),l.setFloat32(128,a,c),l.setUint16(252,2,c),l.setUint16(254,1,c);var u=[[1,0,0,-0],[0,1,0,-0],[0,0,1,-0]];l.setFloat32(256,0,c),l.setFloat32(260,0,c),l.setFloat32(264,0,c),l.setFloat32(268,u[0][3],c),l.setFloat32(272,u[1][3],c),l.setFloat32(276,u[2][3],c),l.setFloat32(280,u[0][0],c),l.setFloat32(284,u[0][1],c),l.setFloat32(288,u[0][2],c),l.setFloat32(292,u[0][3],c),l.setFloat32(296,u[1][0],c),l.setFloat32(300,u[1][1],c),l.setFloat32(304,u[1][2],c),l.setFloat32(308,u[1][3],c),l.setFloat32(312,u[2][0],c),l.setFloat32(316,u[2][1],c),l.setFloat32(320,u[2][2],c),l.setFloat32(324,u[2][3],c);for(var f=new Uint8Array(h,344,348),d="n+1",g=d.length-1;g>=0;g--)f[g]=d.charCodeAt(g)}},{key:"debug",value:function(){var t=this.buffer,e=this.header,n=this.littleEndian,i=new Uint8Array(t,0,o.HEADER_LENGTH);console.title=function(t){console.info(t+" "+"-".repeat(50-t.length))},console.title("header"),console.info("0: sizeof_hdr",e.getUint16(0,n)),console.title("unused"),console.info("4: data_type",String.fromCharCode.apply(null,i.subarray(4,14))),console.info("14: db_name",String.fromCharCode.apply(null,i.subarray(14,32))),console.info("32: extents",e.getUint16(32,n)),console.info("36: session_error",e.getUint16(36,n)),console.info("38: regular",String.fromCharCode.apply(null,i.subarray(38,39))),console.info("39: dim_info",String.fromCharCode.apply(null,i.subarray(38,39))),console.title("dim: Data array dimensions"),console.info("40",e.getUint16(40,n)),console.info("42",e.getUint16(42,n)),console.info("44",e.getUint16(44,n)),console.info("46",e.getUint16(46,n)),console.info("48",e.getUint16(48,n)),console.info("50",e.getUint16(50,n)),console.info("52",e.getUint16(52,n)),console.info("54",e.getUint16(54,n)),console.title("Itent"),console.info("56: intent_p1",e.getFloat32(56,n)),console.info("60: intent_p2",e.getFloat32(60,n)),console.info("64: intent_p3",e.getFloat32(64,n)),console.info("68: intent_code",e.getUint16(68,n)),console.title("Data type"),console.info("70: datatype",e.getUint16(70,n)),console.info("72: bitpix",e.getUint16(72,n)),console.info("74: slice_start",e.getUint16(74,n)),console.title("pixdim: grid spacing"),console.info("76",e.getFloat32(76,n)),console.info("80",e.getFloat32(80,n)),console.info("84",e.getFloat32(84,n)),console.info("88",e.getFloat32(88,n)),console.info("92",e.getFloat32(92,n)),console.info("96",e.getFloat32(96,n)),console.info("100",e.getFloat32(100,n)),console.info("104",e.getFloat32(104,n)),console.title("Voxel"),console.info("108: vox_offset",e.getFloat32(108,n)),console.info("112: scl_slope",e.getFloat32(112,n)),console.info("116: scl_inter",e.getFloat32(116,n)),console.info("120: slice_end",e.getUint16(120,n)),console.info("122: slice_code",String.fromCharCode.apply(null,i.subarray(122,123))),console.info("123: xyzt_units",String.fromCharCode.apply(null,i.subarray(123,124))),console.title("Intensity:"),console.info("124: cal_max",e.getFloat32(124,n)),console.info("128: cal_min",e.getFloat32(128,n)),console.title("Time"),console.info("132: slice_duration",e.getFloat32(132,n)),console.info("136: toffset",e.getFloat32(136,n)),console.title("Unused"),console.info("140: glmax",e.getUint16(140,n)),console.info("144: glmin",e.getUint16(144,n)),console.title("History"),console.info("148: description",String.fromCharCode.apply(null,i.subarray(148,228))),console.info("228: auxiliary file name",String.fromCharCode.apply(null,i.subarray(228,252))),console.title("Transform"),console.info("252: qform_code",e.getUint16(252,n)),console.info("254: sform_code",e.getUint16(254,n)),console.info("256: quatern_b",e.getFloat32(256,n)),console.info("260: quatern_c",e.getFloat32(260,n)),console.info("264: quatern_d",e.getFloat32(264,n)),console.info("268: qoffset_x",e.getFloat32(268,n)),console.info("272: qoffset_y",e.getFloat32(272,n)),console.info("276: qoffset_z",e.getFloat32(276,n)),console.title("srow_x"),console.info("280",e.getFloat32(280,n)),console.info("284",e.getFloat32(284,n)),console.info("288",e.getFloat32(288,n)),console.info("292",e.getFloat32(292,n)),console.title("srow_y"),console.info("296",e.getFloat32(296,n)),console.info("300",e.getFloat32(300,n)),console.info("304",e.getFloat32(304,n)),console.info("308",e.getFloat32(308,n)),console.title("srow_z"),console.info("312",e.getFloat32(312,n)),console.info("316",e.getFloat32(316,n)),console.info("320",e.getFloat32(320,n)),console.info("324",e.getFloat32(324,n)),console.title("Name of data"),console.info("328: intent_name",e.getFloat32(328,n)),console.title("Magic number"),console.info("344: magic",String.fromCharCode.apply(null,i.subarray(344,o.HEADER_LENGTH)))}},{key:"debugView",value:function(){for(var t=this.body.length,e=this.body[0],n=this.body[0],o=1;o<t;o++)n=Math.max(this.body[o],n),e=Math.min(this.body[o],e);console.title("view"),console.info("Number of voxel: %s",t),console.info("Value range: [%s;%s]",e,n)}}],a=[{key:"AXIS",get:function(){return["x","y","z"]}},{key:"HEADER_LENGTH",get:function(){return 352}},{key:"MAX",get:function(){return 1e3}},{key:"create",value:function(e,n,i,s){var a=s.BYTES_PER_ELEMENT,r=o.HEADER_LENGTH+e*n*i*a,l=Array.from(t.values()).indexOf(s),c=Array.from(t.keys())[l],h=new o(new ArrayBuffer(r),!1);return h.setDefaultHeader(e,n,i,8*a,c),h.body=h.createBodyView(),h}}],s&&n(i.prototype,s),a&&n(i,a),Object.defineProperty(i,"prototype",{writable:!1}),o}();function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}const a=function(){function t(e,n,o){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;i(this,t),this.success=n,this.error=o,this.request=new XMLHttpRequest,this.onReadyStateChange=this.onReadyStateChange.bind(this),this.onError=this.onError.bind(this),this.request.timeout=s,this.request.addEventListener("readystatechange",this.onReadyStateChange),this.request.addEventListener("error",this.onError),this.request.addEventListener("timeout",this.onError),this.request.open("GET",e,!0),this.request.responseType="arraybuffer",this.request.send()}var e,n;return e=t,(n=[{key:"onReadyStateChange",value:function(t){this.request.readyState===XMLHttpRequest.DONE&&(200===this.request.status?this.onSuccess(this.request.response):this.onError())}},{key:"onSuccess",value:function(t){this.clear(),this.success(t)}},{key:"onError",value:function(t){this.clear(),this.error()}},{key:"clear",value:function(){this.request&&(this.request.removeEventListener("readystatechange",this.onReadyStateChange),this.request.removeEventListener("error",this.onError),this.request=null)}}])&&s(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function r(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}const l=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.onChange=this.onChange.bind(this),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this.toggle=this.toggle.bind(this),this.next=this.next.bind(this),this.callback=e,this.x=this.getSlider("x",100),this.y=this.getSlider("y",100),this.z=this.getSlider("z",100),this.auto=this.getAutoButton(),this.sliders=[this.x,this.y,this.z],this.current=0,this.frame=null,this.attach()}var e,n;return e=t,n=[{key:"onChange",value:function(t){var e=t.target,n=e.name,o=e.value;this.callback(n,o)}},{key:"toggle",value:function(){this.frame?this.stop():this.start()}},{key:"start",value:function(){this.frame||(this.frame=requestAnimationFrame(this.next))}},{key:"stop",value:function(){this.frame&&(cancelAnimationFrame(this.frame),this.frame=null)}},{key:"next",value:function(){this.frame=requestAnimationFrame(this.next);var t=this.sliders[this.current];t.value===t.max?(t.value=0,this.current=this.current===this.sliders.length-1?0:this.current+1):t.value++,t.dispatchEvent(new Event("input"))}},{key:"setMaxs",value:function(t,e,n){this.x.max=t,this.y.max=e,this.z.max=n}},{key:"getSlider",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=document.createElement("input");return i.type="range",i.name=t,i.min=o,i.max=e,i.step=n,i.value=o,i.addEventListener("input",this.onChange),i}},{key:"getAutoButton",value:function(){var t=document.createElement("button");return t.type="button",t.innerText="Auto",t.addEventListener("click",this.toggle),t}},{key:"attach",value:function(){var t=document.createElement("div");t.className="navigator",t.appendChild(this.x),t.appendChild(this.y),t.appendChild(this.z),t.appendChild(this.auto),document.body.appendChild(t)}}],n&&r(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function c(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}const h=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.cube=this.getCube(),this.size=100,this.axis=["x","y","z"],this.transform={x:function(t){return"translate3d(0, 0, ".concat(t,"px)")},y:function(t){return"translate3d(".concat(t,"px, 0, 0) rotateY(-90deg)")},z:function(t){return"translate3d(0, ".concat(t,"px, 0) rotateX(-90deg)")}},this.attach()}var e,n;return e=t,(n=[{key:"set",value:function(t,e){var n=this.axis.indexOf(t),o=Math.round(e*this.size)-this.size/2,i=this.transform[t](o);this.cube.faces[n].style.transform=i,this.cube.className="cube ".concat(t)}},{key:"getCube",value:function(){var t=document.createElement("div");t.className="cube",t.faces=new Array(6);for(var e=0;e<6;e++){var n=document.createElement("figure");t.appendChild(n),t.faces[e]=n}return t}},{key:"attach",value:function(){var t=document.createElement("section");t.className="container",t.appendChild(this.cube),document.body.appendChild(t)}}])&&c(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function u(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function f(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}const d=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.createElement("canvas");u(this,t),this.element=e,this.context=this.element.getContext("2d"),this.scale=1,this.onResize=this.onResize.bind(this),window.addEventListener("resize",this.onResize),this.attach()}var e,n;return e=t,n=[{key:"setDimensions",value:function(t,e){if(this.element.width===t&&this.element.height===e)return null;this.element.width=t,this.element.height=e,this.context.globalCompositeOperation="copy",this.context.imageSmoothingEnabled=!1,this.onResize()}},{key:"load",value:function(t){this.setDimensions(t.width,t.height),this.context.putImageData(t,0,0)}},{key:"attach",value:function(){document.body.appendChild(this.element)}},{key:"onResize",value:function(){this.scale=this.getScale();var t=Math.round(this.element.width*this.scale),e=Math.round(this.element.height*this.scale);this.element.style.width="".concat(t,"px"),this.element.style.height="".concat(e,"px")}},{key:"getScale",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,e=this.element,n=e.width,o=e.height,i=window,s=i.innerWidth,a=i.innerHeight,r=Math.min(s,a)/Math.max(n,o);return Math.floor(r*t)/t}}],n&&f(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function g(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function y(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var v=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.createElement("p");g(this,t),this.element=e,this.element.className="loader",this.attach()}var e,n;return e=t,(n=[{key:"attach",value:function(){document.body.appendChild(this.element)}},{key:"detach",value:function(){document.body.removeChild(this.element)}}])&&y(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function m(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var p=new(function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.setSlice=this.setSlice.bind(this),this.onFileLoaded=this.onFileLoaded.bind(this),this.onError=this.onError.bind(this),this.loader=new v,this.canvas=new d,this.navigator=new l(this.setSlice),this.cube=new h,this.volume=null,this.axis=0,this.request=new a(e,this.onFileLoaded,this.onError)}var e,n;return e=t,(n=[{key:"onFileLoaded",value:function(t){this.volume=new o(t),this.loader.detach();var e=this.volume,n=e.x,i=e.y,s=e.z,a=8*this.volume.bitPerVoxel;console.info("Volume: ".concat(n," ⨉ ").concat(i," ⨉ ").concat(s)),console.info("Voxel: ".concat(a," octets")),console.info("Body: ".concat(this.volume.body.length)),this.navigator.setMaxs(n-1,i-1,s-1),this.setSlice("x",Math.round(n/2))}},{key:"setSlice",value:function(t,e){this.cube.set(t,e/this.volume[t]),this.canvas.load(this.volume.getSlice(t,e))}},{key:"onError",value:function(t){console.error(t)}}])&&m(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),t}())("brain.nii");"function"==typeof parent.setDemo&&parent.setDemo(p)})();